---
layout: post
title: IPTV 与互联网融合
date: 2020-01-15 17:10
updated: 2020-01-20 00:46
categories: 教程
tags: 
    - IPTV
    - OpenWrt
    - Lean
    - udpxy
    - IGMP
    - RTSP
urlname: 23
comment: true
---

因为家里弱电箱到客厅电视只有一条线，在原有情况下无法做到 IPTV 和互联网在同一线路上通过。本教程不仅可以解决单线路同时播放互联网软件节目，还可以让任意设备播放 IPTV 节目。

<!-- more -->

## 介绍

### 依赖

- 需要一个能够刷 OpenWrt 的路由器(需具有`数据包镜像`和 `udpxy` 功能/插件)用于抓包和后续的使用，因为其功耗较低且价格比较便宜 Newifi D2 拼多多 100 以下就可以拿下
- 能够正常播放节目的 IPTV 机顶盒，如果自己家里都没有能用的那就没有融合一说了

### 环境

> 因为不同地区网络环境不同，我这里是四川电信，但是可能在同一个省环境都会不一样，所以并不一定在其他地区可用。

| 设备 | 型号 | 软件 |
| -- | -- | -- |
| 光猫 | TEWA-500E | - |
| 主路由 | Newifi-D2 | Lean OpenWrt R9.6.1 |
| AP | 腾达 AC6 | - |

![网络结构拓扑图](https://st.blackyau.net/blog/23/1.png)

无需电信 IPTV 机顶盒，也可在任何设备上通过 http 链接直接播放直播节目。下图分别为 PotPlayer(PC) 和 超级直播(Android) 播放节目效果图。

![PC PotPlayer](https://st.blackyau.net/blog/23/2.jpg)

![Android 超级直播](https://st.blackyau.net/blog/23/3.jpg)

### iGMP与RTSP

在 IPTV 中常见的两种用于播放直播节目的协议分别为 IGMP 和 RTSP，他们之间的差异如下。

| 协议 | 节目类型 | 可用时间 | 鉴权 |
| :---: | :---: | :---: | :---: |
| IGMP | 直播 | 长期 | 强制 |
| RTSP | 直播/回放/点播 | 短期 | 非强制 |

#### IGMP

**网路群组管理协议**（英语：Internet Group Management Protocol，缩写：IGMP）是用于管理网路协议多播组成员的一种通信协议，有时候我也会将其称为**组播**。

在电信这边，组播地址通常很少变化，但是很重要的是它只能看直播不能看回放。又因为它的地址是内网地址，所以你必须要获取到电信的内网IP才能正常播放。我比较倾向于使用组播地址，因为电视节目回放有啥可看的，一般都是爱奇艺什么的了，而且最重要的是它的地址很少变化，这样就给不会倒腾的家人减少了很多麻烦。

原理上组播和广播(给网络里的所有人都发送一个消息)有点相似，但是组播会划分一个更小的范围，并且这个范围里面设备的名单会同时由客户端和主机端进行维护，路由器会根据不同的组别来转发不同的数据。

下面假装这个网络里面，有3组人正在分别在看3个节目。

![IGMP1](https://st.blackyau.net/blog/23/4.png)

正在收看 CCTV-251 的朋友说，这太假了。我想看点正能量的、让人血脉喷张的。然后请求换到 正在播放 CCTV-1 的 `igmp://239.93.22.133:9260`

![IGMP2](https://st.blackyau.net/blog/23/5.png)

路由器随后听到了这位朋友的呼唤，然后就将它放进了 CCTV-1 的组里。

![IGMP3](https://st.blackyau.net/blog/23/6.png)

通过上面的例子你大致能了解到 IGMP 协议的工作原理，可以简单的总结为 IGMP 就是 `一对多`，下面的一个例子则是和 IGMP 相反。

### RTSP

**实时流协议**（Real Time Streaming Protocol，RTSP）是一种网络应用协议，专为娱乐和通信系统的使用，以控制流媒体服务器。该协议用于创建和控制终端之间的媒体会话。媒体服务器的客户端发布VCR命令，例如播放，录制和暂停，以便于实时控制从服务器到客户端（视频点播）或从客户端到服务器（语音录音）的媒体流，有时候我也会将其称为**时移**。

原理上 RTSP 和常见的 HTTP 协议比较相似，也就是 `一对一`，下面这个图可以帮助你理解。

你在观看节目的时候，可以随意的后退暂停，也可以自己想看什么就看什么，不用加入别人的组，整个资源都被你一个人享用。就和你平时看爱奇艺，B站什么的没区别。

![RTSP](https://st.blackyau.net/blog/23/7.png)

正如上面的介绍一样，RTSP 的主要特点就是可以时移，也就是可以拖动进度条。而且大部分地区的 RTSP 地址都是公网 IP，甚至还可以在获取到地址后，不需要任何授权都可以直接正常播放。

所以网络上流传的 IPTV 直播源基本都是 RTSP 地址。不过四川电信这边 RTSP 有鉴权，必须要以电信的内网 IP 访问才行。

同时又因为有部分套餐的 IPTV 是没有回放权限的，所以电信应该还需要验证是谁在播放，这就让观看它成为了比较麻烦的事情(不同地区情况不同，这里只针对我所在的地区)。

## 目标

通过了我上面对 IGMP 和 RTSP 协议的介绍，相信你对他俩都有了一定的了解。接下来我将为你详细介绍本次教程的内容。

- 介绍适合本项目的硬件设备
- 软件安装及环境配置
- 抓包获取 IPTV 的 IGMP 和 RTSP 播放地址
- 使用 igmpproxy 将所有 IGMP 数据转发到 IPTV 口
- 使用 udpxy 将 IGMP 地址转换为 HTTP
- 在电视盒子、手机和PC上正常播放
- 在外欣赏自家 IPTV 直播源